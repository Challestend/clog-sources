!function(){
	function getArguments(){
		var col=document.getElementsByTagName("script");
		return{
			length:col.length,
			zIndex:col[col.length-1].getAttribute("zIndex")||-1,
			opacity:col[col.length-1].getAttribute("opacity")||1,
			color:col[col.length-1].getAttribute("color")||"0,0,0",
			count:col[col.length-1].getAttribute("count")||99,
		};
	}

	function resize(){
		canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;
		canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;
		x0=0.5*canvas.width;
		y0=upm+100;
		cur.x=0.5*canvas.width;
		cur.y=canvas.height-dwm-100;
	}

	function drawBlock(x,y,w,h,d){
		con.fillRect(x-d,y-d,w+2*d,h+2*d);
	}

	function drawDigit(id,x){
		var l=10,w=2,ind=canvas.width-2*id*l;
		switch(x){
			case 1:
				drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 2:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind+l,upm+100,0,l,w),drawBlock(ind,upm+100+l,0,l,w);break;
			case 3:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 4:
				drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100,0,l,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 5:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind,upm+100,0,l,w),drawBlock(ind+l,upm+100+l,0,l,w);break;
			case 6:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind,upm+100,0,2*l,w),drawBlock(ind+l,upm+100+l,0,l,w);break;
			case 7:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 8:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind,upm+100,0,2*l,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 9:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+l,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind,upm+100,0,l,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
			case 0:
				drawBlock(ind,upm+100,l,0,w),drawBlock(ind,upm+100+2*l,l,0,w),drawBlock(ind,upm+100,0,2*l,w),drawBlock(ind+l,upm+100,0,2*l,w);break;
		}
	}

	function drawNumber(id,x){
		if(x){
			drawDigit(id,x%10);
			drawNumber(id+1,Math.floor(x/10));
		}
	}

	function drawImage(src,x,y,w,h){
		var img=document.createElement("img");
		img.src="/images/"+src+".png";
		con.drawImage(img,x,y,w,h);
	}

	function dist(x1,y1,x2,y2){
		return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));
	}

	function eraseBullet(p){
		lst.splice(lst.indexOf(p),1);
	}

	function pattern1(){
		var n=6,v0=0.97,vx=3.26,vt=0.16,ax=0.10;
		for(var i=0;i<n;++i){
			var v=v0+vx*(Math.cos(vt*time)+1)/2,a=time*ax+2*i/n*Math.PI;
			lst.push({x:x0-133*Math.cos(a),y:y0-133*Math.sin(a),vx:v*Math.cos(a),vy:v*Math.sin(a),ax:0,ay:0,rad:4,bound:true,time:0,event:function(){}});
		}
	}

	function pattern2(){
		var n1=12,n2=10;
		for(var i=0;i<n1;++i)
			for(var j=-n2;j<=n2;++j){
				var g1=0.0223-0.0008*Math.abs(j),g2=0.0101-0.0004*Math.abs(j),a=2*i/n1*Math.PI+j*0.017+Math.atan2(cur.y-y0,cur.x-x0);
				lst.push({x:x0,y:y0,vx:0,vy:0,ax:g1*Math.cos(a),ay:g1*Math.sin(a),rad:12,bound:true,time:0,event:function(){}}),
				lst.push({x:x0,y:y0,vx:0,vy:0,ax:g2*Math.cos(a+Math.PI/n1),ay:g2*Math.sin(a+Math.PI/n1),rad:8,bound:true,time:0,event:function(){}});
			}
	}

	function pattern3(){
		var n=256;
		for(var i=0;i<n;++i){
			var a=2*i/n*Math.PI,g=rnd(0,0.002);
			lst.push({x:x0,y:y0,vx:2.28*Math.cos(a),vy:2.28*Math.sin(a),ax:g*Math.cos(a),ay:g*Math.sin(a),rad:10,bound:true,time:0,event:function(){}});
		}
	}

	function pattern4(){
		var n1=24,n2=10,r0=60,dx=0.0004,a0=rnd(0,2*Math.PI),om=0.023;
		for(var i=0;i<n1;++i){
			var a=a0+2*i/n1*Math.PI;
			for(var j=0;j<5;++j){
				var x1=r0*Math.cos(a+0.8*j*Math.PI),y1=r0*Math.sin(a+0.8*j*Math.PI),
					x2=r0*Math.cos(a+0.8*(j+1)*Math.PI),y2=r0*Math.sin(a+0.8*(j+1)*Math.PI);
				for(var k=0;k<n2;++k){
					var x=x1+k/n2*(x2-x1),y=y1+k/n2*(y2-y1);
					lst.push({x:x0,y:y0,vx:0,vy:0,ax:0,ay:0,rad:5,bound:false,time:0,dx:dx*dist(x,y,0,0),a1:a,a2:Math.atan2(y,x),om:(2*(i%2)-1)*om,event:function(){
						this.x=x0+this.time*(200-this.time)*0.0438*Math.cos(this.a1)+this.time*(200-this.time)*this.dx*Math.cos(this.a2+this.time*this.om);
						this.y=y0+this.time*(200-this.time)*0.0438*Math.sin(this.a1)+this.time*(200-this.time)*this.dx*Math.sin(this.a2+this.time*this.om);
						if(this.time>=200)
							eraseBullet(this);
					}});
				}
			}
		}
	}

	function pattern5(){
		var n=512,r0=1750,rx=3.47,minr=663,r=r0-time*rx>=minr?r0-time*rx:minr,a0=rnd(0,2*Math.PI);
		for(var i=0;i<n;++i){
			var v=rnd(9.96,14.23),a=2*i/n*Math.PI+a0,g=rnd(0.06,0.09),d=a+rnd(-0.4,0.4)*Math.PI;
			lst.push({x:x0+r*Math.cos(a),y:y0+r*Math.sin(a),vx:v*Math.cos(a),vy:v*Math.sin(a),ax:g*Math.cos(d),ay:g*Math.sin(d),rad:3,bound:true,time:0,event:function(){}});
		}
	}

	function pattern6(){
		var v=rnd(1.62,3.26),a=rnd(0,2*Math.PI);
		lst.push({x:x0,y:y0,vx:v*Math.cos(a),vy:v*Math.sin(a),ax:0,ay:0,rad:4,bound:true,time:0,event:function(){
			var p=rnd(1,1.1);
			this.vx*=p;
			this.vy*=p;
		}});
	}

	function movement(){
		con.clearRect(0,0,canvas.width,canvas.height);
		if(enable){
			// x0=cur.x,y0=cur.y;
			lst.forEach(function(p){
				p.x+=p.vx;
				p.y+=p.vy;
				p.vx+=p.ax;
				p.vy+=p.ay;
				++p.time;
			});
			// pattern1();
			// time%200==0&&pattern2();
			// time%40==0&&pattern3();
			// time%200==0&&pattern4();
			// pattern5();
			// pattern6();
			lst.forEach(function(p){
				p.event();
			});
			var hit=false;
			lst.forEach(function(p){
				if(p.bound&&(p.x<0||p.x>canvas.width||p.y<0||p.y>canvas.height))
					eraseBullet(p);
				else{
					drawImage("circleBullet",p.x-p.rad,p.y-p.rad,2*p.rad,2*p.rad);
					hit|=dist(p.x,p.y,cur.x,cur.y)<=0.88*(p.rad+cur.rad);
				}
			});
			cd?(--cd):hit&&(++death,cd=60);
			L&&(cur.x-=sp);
			U&&(cur.y-=sp);
			R&&(cur.x+=sp);
			D&&(cur.y+=sp);
			cur.x<0&&(cur.x=0);
			cur.y<upm&&(cur.y=upm);
			cur.x>canvas.width&&(cur.x=canvas.width);
			cur.y>canvas.height-dwm&&(cur.y=canvas.height-dwm);
			++time;
			(cd&&time%10<5)||drawImage("player",cur.x-cur.rad,cur.y-cur.rad,2*cur.rad,2*cur.rad);
			drawNumber(8,death);
		}
		func(movement);
	}

	var canvas=document.createElement("canvas"),
		args=getArguments(),
		con=canvas.getContext("2d"),
		func=window.requestAnimationFrame||
		window.webkitRequestAnimationFrame||
		window.mozRequestAnimationFrame||
		window.oRequestAnimationFrame||
		window.msRequestAnimationFrame||
		function(i){window.setTimeout(i,1000/45)};
	canvas.id="c_n"+args.length;
	canvas.style.cssText="position:fixed;top:0;left:0;z-index:"+args.zIndex+";opacity:"+args.opacity;
	document.getElementsByTagName("body")[0].appendChild(canvas);
	var cur={x:null,y:null,rad:3},lst=[],enable=true,
		L=false,U=false,R=false,D=false,sp=4,cd=0,death=0,
		upm=93,dwm=104,time=0,x0=0,y0=0,
		rnd=function(L,R){return L+Math.random()*(R-L)};
	resize();
	window.onresize=resize;
	window.ondblclick=function(){enable=enable?false:true;};
	window.onkeydown=function(p){
		p.keyCode==37&&(L=true);
		p.keyCode==38&&(U=true);
		p.keyCode==39&&(R=true);
		p.keyCode==40&&(D=true);
	};
	window.onkeyup=function(p){
		p.keyCode==37&&(L=false);
		p.keyCode==38&&(U=false);
		p.keyCode==39&&(R=false);
		p.keyCode==40&&(D=false);
	};
	setTimeout(function(){movement();},100);
}();
